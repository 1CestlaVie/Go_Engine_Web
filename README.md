# GoBattle - 围棋AI对战平台

GoBattle是一个基于Web的围棋AI对战平台，支持用户上传ONNX格式的围棋AI模型进行自动化对战，并提供实时观战、积分排行等功能。

## 功能特性

### 🎯 核心功能
- **用户认证系统**：基于预设账号密码的用户登录系统
- **模型上传管理**：支持上传ONNX格式的围棋AI模型（支持分片存储）
- **自动化对战**：3局2胜制对战系统，每局5场，每场400手限定
- **实时观战**：通过WebSocket实现实时对战画面同步
- **积分排行榜**：基于对战胜负的积分系统和排行榜展示
- **对战记录**：详细的历史对战记录查询

### ⚙️ 技术特色
- **ONNX支持**：完全支持ONNX格式模型推理，兼容各种深度学习框架导出的模型
- **并发控制**：实现对战队列系统，限制最大并发对战数避免服务器过载
- **围棋规则**：完整实现19×19标准围棋规则，包括打劫、提子等复杂规则
- **模型管理**：每个用户组最多可上传3个模型，支持模型删除和替换

## 技术架构

### 后端技术栈
- **Python Flask**：Web应用框架
- **Flask-SocketIO**：实时双向通信
- **ONNX Runtime**：高性能模型推理引擎
- **PyTorch**：模型训练和导出（可选）

### 前端技术栈
- **HTML/CSS/JavaScript**：响应式用户界面
- **Socket.IO Client**：WebSocket客户端通信

### 数据存储
- **JSON文件**：用户模型信息、对战记录和积分数据持久化
- **文件系统**：上传的ONNX模型文件存储

## 快速开始

### 环境要求
- Python 3.8+
- pip包管理器

### 安装依赖
```bash
pip install -r requirements.txt
```

### 运行应用
```bash
python app.py
```

应用将在 `http://localhost:5000` 启动

## 使用指南

### 1. 用户登录
使用预设的账号密码登录系统：
- 账号：小组英文缩写（如：jyjlym）
- 密码：小组英文缩写（如：jyjlym）

### 2. 上传模型
1. 进入仪表板页面
2. 选择ONNX模型文件上传
3. 可选择性上传关联的.data文件（保持原始文件名）

### 3. 发起对战
1. 在仪表板选择自己的模型
2. 选择对手小组和其模型
3. 点击"发起对战"按钮
4. 系统将自动排队执行对战

### 4. 观看对战
- 对战开始后可点击"进入对局房间"实时观看
- 对战信息包括大比分、小比分、手数、提子数等

### 5. 查看排行
- 访问排行榜页面查看各模型积分排名
- 可查看详细的对战历史记录

## 项目结构

```
goBattle/
├── app.py                 # 主应用入口
├── go_engine.py           # 围棋规则引擎
├── onnx_inference.py      # ONNX模型推理
├── go_model.py            # PyTorch模型定义和导出
├── go_gui.py              # 本地GUI对战界面
├── leaderboard.py         # 排行榜和积分系统
├── config.py              # 配置文件
├── requirements.txt       # 依赖包列表
├── 账号密码.txt            # 用户账号信息
├── user_models.json       # 用户模型映射
├── leaderboard_data.json  # 排行榜数据
├── templates/             # HTML模板文件
├── uploads/               # 上传的模型文件
└── models/                # 默认模型目录
```

## 模型要求

### 输入格式
- 形状：`(batch_size, 3, 19, 19)`
- 通道0：当前玩家的棋子（1表示有子，0表示无子）
- 通道1：对手的棋子（1表示有子，0表示无子）
- 通道2：全1矩阵（表示当前玩家）

### 输出格式
- Policy head：`(batch_size, 361)` 落子概率分布（19×19个位置）
- Value head：`(batch_size, 1)` 局面评估值 [-1, 1]

## 积分规则

1. **胜负积分**：
   - 胜者：+3分
   - 败者：+1分
   - 平局：双方各+2分

2. **冻结机制**：
   - 同一对模型间的对战记录达到4场后，积分将被冻结不再更新

3. **排行榜**：
   - 按积分从高到低排序
   - 显示用户信息、模型名称和积分

## 开发说明

### 本地开发
```bash
# 安装开发依赖
pip install -r requirements.txt

# 启动开发服务器
python app.py
```

### 代码结构
- `app.py`：Flask应用主文件，包含路由和业务逻辑
- `go_engine.py`：围棋规则实现，包括落子、提子、打劫等
- `onnx_inference.py`：ONNX模型加载和推理接口
- `go_model.py`：PyTorch模型定义和ONNX导出功能
- `go_gui.py`：本地GUI对战界面（可选）
- `leaderboard.py`：排行榜和积分计算逻辑

## 部署说明

### 生产环境部署
1. 修改`app.py`中的secret_key为安全的随机字符串
2. 配置反向代理（如Nginx）处理静态文件和SSL
3. 使用生产级WSGI服务器（如Gunicorn）运行应用
4. 配置适当的进程数和资源限制

### 性能优化
- 使用`onnxruntime-gpu`替代`onnxruntime`以启用GPU加速
- 调整`MAX_CONCURRENT_BATTLES`参数控制并发对战数
- 定期清理上传目录中的旧模型文件

## 贡献指南

欢迎提交Issue和Pull Request来改进项目！

## 鸣谢

特别感谢以下项目和技术的支持：

- **Qwen Coder**：提供了强大的AI编程辅助，帮助快速开发和调试代码
- **Qwen3-Coder-480b-a35b-instruct**：作为底层大语言模型，提供了智能代码生成和问题解决能力

## 许可证

本项目仅供教学和学习使用。